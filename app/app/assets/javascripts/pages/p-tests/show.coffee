pageLoad 'tests_show', ->
  new Wall.Gallery $('.images-test .shiki-wall')

  require.ensure [], (require) =>
    init_page require('highcharts')

init_page = (Highcharts) ->
  traffic = $('.traffic-test').data 'stats'

  $('.traffic-test').highcharts chart_options
    series: [
      name: 'Просмотры'
      pointInterval: 24 * 3600 * 1000
      pointStart: new Date(traffic.first().date).getTime()
      data: traffic.map (v) -> v.page_views
      visible: false
      color: Highcharts.getOptions().colors[3]
      fillColor:
        linearGradient:
          x1: 0
          y1: 0
          x2: 0
          y2: 1
        stops: [[0, Highcharts.getOptions().colors[3]], [1, Highcharts.Color(Highcharts.getOptions().colors[3]).setOpacity(0).get("rgba")]]
    ,
      name: 'Визиты'
      pointInterval: 24 * 3600 * 1000
      pointStart: new Date(traffic.first().date).getTime()
      data: traffic.map (v) -> v.visits
      visible: false
      color: Highcharts.getOptions().colors[1]
      fillColor:
        linearGradient:
          x1: 0
          y1: 0
          x2: 0
          y2: 1
        stops: [[0, Highcharts.getOptions().colors[1]], [1, Highcharts.Color(Highcharts.getOptions().colors[1]).setOpacity(0).get("rgba")]]
    ,
      name: 'Уникальные посетители'
      pointInterval: 24 * 3600 * 1000
      pointStart: new Date(traffic.first().date).getTime()
      data: traffic.map (v) -> v.visitors
      color: Highcharts.getOptions().colors[0]
      fillColor:
        linearGradient:
          x1: 0
          y1: 0
          x2: 0
          y2: 1
        stops: [[0, Highcharts.getOptions().colors[0]], [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get("rgba")]]
    ]

chart_options = (options) ->
  $.extend true,
    chart:
      zoomType: 'x'
      type: 'areaspline'
    title: null
    xAxis:
      type: "datetime"
      title: null
      maxZoom: 14 * 24 * 3600000
      dateTimeLabelFormats:
        millisecond: '%H:%M:%S.%L'
        second: '%H:%M:%S'
        minute: '%H:%M'
        hour: '%H:%M'
        day: '%e. %b'
        week: '%e. %b'
        month: '%b'
        year: '%Y'
    yAxis:
      title: null
      gridLineColor: "#eaeaea"
      min: 0
    tooltip:
      shared: true
    legend:
      borderRadius: 0
      borderWidth: 0
    plotOptions:
      areaspline:
        lineWidth: 1
        fillOpacity: 0.5
        marker:
          enabled: false
        shadow: false
        states:
          hover:
            lineWidth: 1
        threshold: null
    credits: false
  , options
